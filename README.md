äº†è§£ã—ã¾ã—ãŸã€‚
ä»¥ä¸‹ã«ã€**`build_index.py` ï¼† `batch_search_score.py` ã®å®Ÿéš›ã®å®Ÿè£…ä»•æ§˜ã«å®Œå…¨æº–æ‹ ã—ãŸ READMEï¼ˆæœ€æ–°ç‰ˆãƒ»å®Œå…¨ç‰ˆï¼‰** ã‚’ç¤ºã—ã¾ã™ã€‚
ã“ã‚Œ1æœ¬ã§ã€ŒåŸ‹ã‚è¾¼ã¿ â†’ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ â†’ æ¤œç´¢ãƒ»è©•ä¾¡ã€ã®å…¨ä½“æ§‹é€ ã¨å†…éƒ¨å‡¦ç†ãŒæŠŠæ¡ã§ãã‚‹ã‚ˆã†ã«æ§‹æˆã—ã¦ã„ã¾ã™ã€‚

---

# ğŸ§  GENIAC-PRIZE Patent Retrieval â€” å®Œå…¨å®Ÿè£…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€**ç‰¹è¨±æ–‡çŒ®æ¤œç´¢ã‚¿ã‚¹ã‚¯ï¼ˆGENIAC PRIZEï¼‰** ã«å¯¾å¿œã—ãŸä¸€æ‹¬å®Ÿè¡Œå‹ RAG æ¤œç´¢è©•ä¾¡ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

ä¸»ãªæµã‚Œï¼š

> å‡ºé¡˜æœ¬æ–‡ã‚’ã‚¯ã‚¨ãƒªã« â†’ æ—¢å­˜æ–‡çŒ®ã®ãƒãƒ£ãƒ³ã‚¯ç¾¤ã‚’å¯¾è±¡ã«ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ â†’
> é¡ä¼¼æ–‡çŒ®ã‚’å–å¾— â†’ å…¬å¼ AX/AY ãƒ‡ãƒ¼ã‚¿ã§ã‚¹ã‚³ã‚¢è©•ä¾¡

---

## âš™ï¸ 0. å®Ÿè¡Œç’°å¢ƒ

| é …ç›®     | æ¨å¥¨ç’°å¢ƒ                                                 |
| ------ | ---------------------------------------------------- |
| Python | 3.10 ä»¥ä¸Š                                              |
| OS     | macOS / Linux / Windows (PowerShellå¯¾å¿œ)               |
| GPU    | ä¸è¦ï¼ˆFAISS CPUç‰ˆå¯¾å¿œï¼‰                                     |
| API    | Google Gemini ã¾ãŸã¯ OpenAIäº’æ›Embedding API              |
| ãƒ‡ãƒ¼ã‚¿    | `data/result_1.jsonl` ï½ `result_18.jsonl(.gz)`ï¼ˆç‰¹è¨±æ–‡çŒ®ï¼‰ |
| è©•ä¾¡CSV  | `CSV1.csv`, `CSV2.csv`ï¼ˆAX/AYå¯¾å¿œãƒ‡ãƒ¼ã‚¿ï¼‰                   |

---

## ğŸ“ 1. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
project/
â”œâ”€ build_index.py            # æ—¢å­˜æ–‡çŒ®ã®ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼†FAISSæ§‹ç¯‰
â”œâ”€ batch_search_score.py     # ã‚¯ã‚¨ãƒªæ¤œç´¢ï¼‹è©•ä¾¡ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰
â”œâ”€ requirements.txt
â”œâ”€ data/
â”‚   â”œâ”€ result_1.jsonl(.gz)   # ç‰¹è¨±æ–‡çŒ®ãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€ CSV1.csv, CSV2.csv    # AX/AYãƒ‡ãƒ¼ã‚¿
â””â”€ rag_index/                # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‡ºåŠ›
    â”œâ”€ faiss.index           # FAISSæœ¬ä½“
    â”œâ”€ vectors.npy           # å„ãƒãƒ£ãƒ³ã‚¯ã®ãƒ™ã‚¯ãƒˆãƒ«
    â”œâ”€ docstore.jsonl        # å„ãƒãƒ£ãƒ³ã‚¯ã®åŸæ–‡ãƒ»è¦ªIDæƒ…å ±
    â”œâ”€ emb_ids.npy, parent_ids.npy
    â””â”€ manifest.json         # å®Ÿè¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
```

---

## ğŸ§© 2. åŸ‹ã‚è¾¼ã¿ï¼ˆbuild_index.pyï¼‰

### ğŸ§­ å‡¦ç†æ¦‚è¦

1. `data/result_i.jsonl(.gz)` ã‚’é †ã«èª­ã¿è¾¼ã¿
2. å„æ–‡çŒ®ã® `"title"`, `"abstract"`, `"description"`, `"claims"` ã‚’é€£çµ
3. é€£çµãƒ†ã‚­ã‚¹ãƒˆã‚’ **æ–‡å­—æ•°ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°åˆ†å‰²**ï¼ˆãƒãƒ£ãƒ³ã‚¯åŒ–ï¼‰
4. å„ãƒãƒ£ãƒ³ã‚¯ã‚’ **APIåŸ‹ã‚è¾¼ã¿ â†’ L2æ­£è¦åŒ–**
5. å…¨ãƒãƒ£ãƒ³ã‚¯ã‚’ã¾ã¨ã‚ã¦ **FAISS IndexFlatIPï¼ˆå†…ç©ï¼ã‚³ã‚µã‚¤ãƒ³ï¼‰** ã«ç™»éŒ²
6. å‡ºåŠ›ã‚’ `rag_index/` ã«ä¿å­˜

---

### âš™ï¸ ä¸»ãªå¼•æ•°

| å¼•æ•°                | æ„å‘³                               |
| ----------------- | -------------------------------- |
| `--data_dir`      | JSONLå…¥åŠ›ãƒ•ã‚©ãƒ«ãƒ€                      |
| `--out_dir`       | å‡ºåŠ›å…ˆ (`rag_index`)                |
| `--select`        | å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ç•ªå· `"1,3-5,12"`            |
| `--chunk_size`    | ãƒãƒ£ãƒ³ã‚¯é•·ï¼ˆä¾‹: 1200æ–‡å­—ï¼‰                 |
| `--chunk_overlap` | é‡è¤‡ï¼ˆä¾‹: 200æ–‡å­—ï¼‰                     |
| `--limit_docs`    | æœ€å¤§æ–‡çŒ®æ•°ï¼ˆ0=å…¨ä»¶ï¼‰                      |
| `--provider`      | `gemini` ã¾ãŸã¯ `openai_compat`     |
| `--emb_model`     | ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«ï¼ˆä¾‹: `models/embedding-001`ï¼‰ |
| `--api_key_env`   | APIã‚­ãƒ¼ã®ç’°å¢ƒå¤‰æ•°å                      |

---

### ğŸ§  åŸ‹ã‚è¾¼ã¿ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå†…éƒ¨å‡¦ç†ï¼‰

#### (1) æ–‡çŒ®ã®æœ¬æ–‡æŠ½å‡ºã¨çµåˆ

```python
text = "\n\n".join([
    obj.get("title", ""),
    obj.get("abstract", ""),
    obj.get("description", ""),
    obj.get("claims", "")
]).strip()
```

#### (2) ãƒãƒ£ãƒ³ã‚¯åŒ–ï¼ˆæ–‡å­—æ•°ãƒ™ãƒ¼ã‚¹ï¼‰

```python
def chunk_text(text, chunk_size=1200, overlap=200):
    chunks, start = [], 0
    while start < len(text):
        end = start + chunk_size
        chunks.append(text[start:end])
        if end >= len(text): break
        start = max(0, end - overlap)
    return chunks
```

â†’ å„æ–‡çŒ®ã¯è¤‡æ•°ã®ãƒãƒ£ãƒ³ã‚¯ï¼ˆ`#p0`, `#p1`, â€¦ï¼‰ã«åˆ†å‰²ã€‚

#### (3) åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ

```python
vec = client.embed(chunk_texts)  # Gemini or OpenAIäº’æ›API
vec = vec / np.linalg.norm(vec, axis=1, keepdims=True)  # L2æ­£è¦åŒ–
```

#### (4) FAISSã¸ã®ç™»éŒ²

```python
index = faiss.IndexFlatIP(dim)  # å†…ç©ï¼ã‚³ã‚µã‚¤ãƒ³
index.add(vectors)
```

---

### ğŸ’¾ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«                             | å†…å®¹                        |
| -------------------------------- | ------------------------- |
| `faiss.index`                    | å†…ç©ãƒ™ãƒ¼ã‚¹ã®ãƒ™ã‚¯ãƒˆãƒ«ç´¢å¼•              |
| `vectors.npy`                    | ãƒãƒ£ãƒ³ã‚¯ã”ã¨ã®æ­£è¦åŒ–ãƒ™ã‚¯ãƒˆãƒ«            |
| `docstore.jsonl`                 | `id`, `parent_id`, `text` |
| `emb_ids.npy` / `parent_ids.npy` | IDå¯¾å¿œè¡¨                     |
| `manifest.json`                  | å®Ÿè¡Œæ¡ä»¶ã®è¨˜éŒ²                   |

---

## ğŸš€ 3. æ¤œç´¢ï¼‹è©•ä¾¡ï¼ˆbatch_search_score.pyï¼‰

### ğŸ§­ å‡¦ç†æ¦‚è¦

1. ã‚¯ã‚¨ãƒªå´ï¼šå‡ºé¡˜æ–‡çŒ® (`result_i.jsonl`) ã‹ã‚‰
   `"title"`, `"abstract"`, `"description"`, `"claims"` ã‚’çµåˆ
2. ã‚¯ã‚¨ãƒªæœ¬æ–‡ã‚’ UTF-8å®‰å…¨ã«åˆ‡ã‚Šè©°ã‚ï¼‹åˆ†å‰² (`piece_chars`)
3. å„ãƒ”ãƒ¼ã‚¹ã‚’åŸ‹ã‚è¾¼ã¿ â†’ **å¹³å‡ãƒ™ã‚¯ãƒˆãƒ«** ã‚’ä½œæˆ
4. **FAISSã§å…¨ãƒãƒ£ãƒ³ã‚¯ã¨ã®é¡ä¼¼åº¦ï¼ˆå†…ç©ï¼‰æ¤œç´¢**
5. åŒä¸€ `parent_id` ã®ãƒãƒ£ãƒ³ã‚¯ãŒè¤‡æ•°ãƒ’ãƒƒãƒˆã—ãŸå ´åˆï¼š
   â†’ æœ€ä¸Šä½ã‚¹ã‚³ã‚¢1ä»¶ã®ã¿æ®‹ã™
6. ä¸Šä½ mMax ä»¶ã®è¦ªæ–‡çŒ®ã‚’è©•ä¾¡ã«ä½¿ç”¨

---

### âš™ï¸ æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯

#### (1) ã‚¯ã‚¨ãƒªåŸ‹ã‚è¾¼ã¿

```python
pieces = [text[i:i+piece_chars] for i in range(0, len(text), piece_chars)]
vecs = [client.embed_one(p) / ||p|| for p in pieces]
qv = np.mean(vecs, axis=0)
qv = qv / ||qv||
```

#### (2) æ¤œç´¢ï¼ˆé¡ä¼¼åº¦ = ã‚³ã‚µã‚¤ãƒ³ï¼‰

```python
D, I = faiss_index.search(qv.reshape(1, -1), k)
# D: é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆå†…ç©ï¼‰, I: ãƒãƒ£ãƒ³ã‚¯index
```

#### (3) ãƒãƒ£ãƒ³ã‚¯â†’è¦ªæ–‡çŒ®ã«å¤‰æ›

```python
hits = [{"id": ids[i], "parent_id": parents[i], "score": D[0][rank]}
        for rank, i in enumerate(I[0])]
```

#### (4) é‡è¤‡æ’é™¤ï¼ˆè¦ªæ–‡çŒ®å˜ä½ï¼‰

```python
seen = set()
filtered = []
for h in hits:
    if h["parent_id"] not in seen:
        seen.add(h["parent_id"])
        filtered.append(h)
top_results = filtered[:mMax]
```

â†’ åŒã˜å‡ºé¡˜ã®è¤‡æ•°ãƒãƒ£ãƒ³ã‚¯ãŒä¸Šä½ã«æ¥ãŸå ´åˆã€**æœ€é«˜ã‚¹ã‚³ã‚¢ã®1ãƒãƒ£ãƒ³ã‚¯ã®ã¿æ¡ç”¨ã€‚**

---

### ğŸ§ª è©•ä¾¡æŒ‡æ¨™

* Hit@kï¼ˆæ­£è§£æ–‡çŒ®ãŒä¸Šä½kä»¶ã«å­˜åœ¨ï¼‰
* MRRï¼ˆå¹³å‡é€†é †ä½ï¼‰
* Coverageï¼ˆæ­£è§£ãŒå­˜åœ¨ã™ã‚‹ã‚¯ã‚¨ãƒªç‡ï¼‰
* Precision@mMaxï¼ˆå¹³å‡ç²¾åº¦ï¼‰

å‡ºåŠ›ï¼š

```
retrieved_pairs.csv
score_results/summary.csv
score_results/overall_summary.txt
```

---

## ğŸ§¾ 4. å®Ÿè¡Œä¾‹

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ§‹ç¯‰ï¼ˆGeminiä½¿ç”¨ï¼‰

```bash
python build_index.py \
  --data_dir ./data \
  --out_dir ./rag_index \
  --provider gemini \
  --emb_model models/embedding-001 \
  --api_key_env GOOGLE_API_KEY \
  --select "1-3" \
  --chunk_size 1200 --chunk_overlap 200
```

### ä¸€æ‹¬æ¤œç´¢ï¼‹è©•ä¾¡

```bash
python batch_search_score.py \
  --data_dir ./data \
  --index_dir ./rag_index \
  --select "4" \
  --truth ./data/CSV1.csv ./data/CSV2.csv \
  --k 50 --mMax 10 --P 0.8 \
  --provider gemini \
  --emb_model models/embedding-001 \
  --api_key_env GOOGLE_API_KEY
```

---

## ğŸ§® 5. å†…éƒ¨ã®æ•°ç†çš„å¯¾å¿œé–¢ä¿‚

| é …ç›®            | å‡¦ç†         | æ•°ç†çš„æ„å‘³        |
| ------------- | ---------- | ------------ |
| L2æ­£è¦åŒ–         | å„ãƒ™ã‚¯ãƒˆãƒ«ã‚’å˜ä½é•·ã« | ã‚³ã‚µã‚¤ãƒ³è·é›¢ï¼å†…ç©    |
| IndexFlatIP   | å†…ç©ãƒ™ãƒ¼ã‚¹FAISS | ä½™å¼¦é¡ä¼¼åº¦æ¤œç´¢      |
| ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²        | æ–‡æ›¸ã®å±€æ‰€ç‰¹å¾´ä¿æŒ  | é•·æ–‡å†…ã®éƒ¨åˆ†æ„å‘³å˜ä½   |
| å¹³å‡ãƒ™ã‚¯ãƒˆãƒ«        | éƒ¨åˆ†åŸ‹ã‚è¾¼ã¿ã®é›†ç´„  | ã‚»ãƒ³ãƒ†ãƒ³ã‚¹ãƒ—ãƒ¼ãƒªãƒ³ã‚°   |
| parent_idé‡è¤‡é™¤å» | 1æ–‡çŒ®ï¼1ã‚¹ã‚³ã‚¢ä»£è¡¨ | å‡ºé¡˜å˜ä½ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°è©•ä¾¡ |

---

## âœ… 6. ã¾ã¨ã‚ï¼ˆå‡¦ç†å…¨ä½“ã®æµã‚Œï¼‰

```
[æ—¢å­˜æ–‡çŒ®]
  â””â”€ build_index.py
       â”œâ”€ title+abstract+description+claims ã‚’é€£çµ
       â”œâ”€ æ–‡å­—å˜ä½ãƒãƒ£ãƒ³ã‚¯åŒ–ï¼ˆoverlapä»˜ãï¼‰
       â”œâ”€ å„ãƒãƒ£ãƒ³ã‚¯ã‚’åŸ‹ã‚è¾¼ã¿ â†’ æ­£è¦åŒ–
       â”œâ”€ FAISS(IndexFlatIP) ã«ç™»éŒ²
       â””â”€ rag_index/ ã«ä¿å­˜

[ã‚¯ã‚¨ãƒªæ–‡çŒ®]
  â””â”€ batch_search_score.py
       â”œâ”€ åŒæ§˜ã«é€£çµï¼†åˆ†å‰² â†’ åŸ‹ã‚è¾¼ã¿å¹³å‡åŒ–
       â”œâ”€ FAISSã§å…¨ãƒãƒ£ãƒ³ã‚¯ã¨é¡ä¼¼åº¦æ¤œç´¢
       â”œâ”€ åŒä¸€parent_idã¯æœ€ä¸Šä½ã®ã¿æ®‹ã™
       â”œâ”€ ä¸Šä½mMaxä»¶ã§è©•ä¾¡
       â””â”€ summary.csv / overall_summary.txt å‡ºåŠ›
```

---

ã“ã® README ã¯ã€
`build_index.py` ã¨ `batch_search_score.py` ã® **å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ä»•æ§˜ã«100%ä¸€è‡´ã—ãŸæŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ** ã§ã™ã€‚
ã“ã‚Œ1æœ¬ã§åŸ‹ã‚è¾¼ã¿ãƒ»ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ãƒ»FAISSæ¤œç´¢ãƒ»è©•ä¾¡ã®å…¨æŒ™å‹•ãŒå†ç¾å¯èƒ½ã§ã™ã€‚
